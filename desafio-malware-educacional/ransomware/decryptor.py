#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
Decryptor - Script de Descriptografia
======================================

Descri√ß√£o:
    Script para descriptografar arquivos criptografados pelo
    ransomware simulado. Requer a chave de descriptografia.

Autor: DIO - Desafio de Ciberseguran√ßa
Data: 2025
"""

import os
import sys
from pathlib import Path
from cryptography.fernet import Fernet, InvalidToken
import json


class Decryptor:
    """
    Classe respons√°vel por descriptografar arquivos.
    """
    
    def __init__(self, caminho_chave='chave_secreta.key'):
        """
        Inicializa o descriptografador.
        
        Args:
            caminho_chave (str): Caminho para o arquivo contendo a chave
        """
        self.caminho_chave = caminho_chave
        self.chave = None
        self.cipher = None
        self.arquivos_descriptografados = []
        
    def carregar_chave(self):
        """
        Carrega a chave de descriptografia do arquivo.
        
        Returns:
            bool: True se a chave foi carregada com sucesso, False caso contr√°rio
        """
        try:
            if not os.path.exists(self.caminho_chave):
                print(f"[!] Erro: Arquivo de chave '{self.caminho_chave}' n√£o encontrado!")
                return False
            
            with open(self.caminho_chave, 'rb') as arquivo_chave:
                self.chave = arquivo_chave.read()
            
            self.cipher = Fernet(self.chave)
            print(f"[+] Chave carregada com sucesso!")
            return True
            
        except Exception as e:
            print(f"[!] Erro ao carregar chave: {str(e)}")
            return False
    
    def encontrar_arquivos_criptografados(self, diretorio="test_files"):
        """
        Encontra todos os arquivos com extens√£o .encrypted.
        
        Args:
            diretorio (str): Diret√≥rio onde procurar arquivos
            
        Returns:
            list: Lista de caminhos de arquivos criptografados
        """
        diretorio_path = Path(diretorio)
        
        if not diretorio_path.exists():
            print(f"[!] Diret√≥rio '{diretorio}' n√£o encontrado!")
            return []
        
        arquivos = list(diretorio_path.rglob('*.encrypted'))
        print(f"[+] Encontrados {len(arquivos)} arquivo(s) criptografado(s)")
        
        return arquivos
    
    def descriptografar_arquivo(self, caminho_arquivo):
        """
        Descriptografa um arquivo espec√≠fico.
        
        Args:
            caminho_arquivo (Path): Caminho do arquivo criptografado
            
        Returns:
            bool: True se a descriptografia foi bem-sucedida, False caso contr√°rio
        """
        try:
            # L√™ o conte√∫do criptografado
            with open(caminho_arquivo, 'rb') as arquivo:
                conteudo_criptografado = arquivo.read()
            
            # Descriptografa o conte√∫do
            conteudo_original = self.cipher.decrypt(conteudo_criptografado)
            
            # Remove a extens√£o .encrypted do nome
            nome_original = str(caminho_arquivo).replace('.encrypted', '')
            
            # Salva o arquivo descriptografado
            with open(nome_original, 'wb') as arquivo:
                arquivo.write(conteudo_original)
            
            # Remove o arquivo criptografado
            os.remove(caminho_arquivo)
            
            self.arquivos_descriptografados.append(nome_original)
            print(f"[+] Descriptografado: {Path(nome_original).name}")
            
            return True
            
        except InvalidToken:
            print(f"[!] Erro: Chave inv√°lida para {caminho_arquivo.name}")
            return False
        except Exception as e:
            print(f"[!] Erro ao descriptografar {caminho_arquivo.name}: {str(e)}")
            return False
    
    def descriptografar_todos(self, diretorio="test_files"):
        """
        Descriptografa todos os arquivos encontrados.
        
        Args:
            diretorio (str): Diret√≥rio onde procurar arquivos
            
        Returns:
            int: N√∫mero de arquivos descriptografados com sucesso
        """
        if not self.chave:
            print("[!] Erro: Chave n√£o foi carregada!")
            return 0
        
        arquivos = self.encontrar_arquivos_criptografados(diretorio)
        
        if not arquivos:
            print("[!] Nenhum arquivo criptografado encontrado!")
            return 0
        
        print(f"\n[*] Iniciando descriptografia de {len(arquivos)} arquivo(s)...")
        print("=" * 60)
        
        contador = 0
        for arquivo in arquivos:
            if self.descriptografar_arquivo(arquivo):
                contador += 1
        
        print("=" * 60)
        print(f"[+] Descriptografia conclu√≠da: {contador}/{len(arquivos)} arquivos")
        
        return contador
    
    def limpar_arquivos_auxiliares(self):
        """
        Remove arquivos auxiliares criados durante a simula√ß√£o.
        """
        arquivos_para_remover = [
            'chave_secreta.key',
            'ransomware_log.json',
            'LEIA_ME_URGENTE.txt'
        ]
        
        print("\n[*] Limpando arquivos auxiliares...")
        for arquivo in arquivos_para_remover:
            if os.path.exists(arquivo):
                os.remove(arquivo)
                print(f"    Removido: {arquivo}")
        
        print("[+] Limpeza conclu√≠da!")


def main():
    """
    Fun√ß√£o principal do descriptografador.
    """
    print("\n" + "=" * 60)
    print("  DECRYPTOR - FERRAMENTA DE DESCRIPTOGRAFIA")
    print("=" * 60)
    print("\n[*] Este script ir√° descriptografar os arquivos usando a chave")
    print("    que foi gerada durante a criptografia.\n")
    
    # Inicializa o descriptografador
    decryptor = Decryptor()
    
    # Carrega a chave
    print("[*] Carregando chave de descriptografia...")
    if not decryptor.carregar_chave():
        print("\n[!] N√£o foi poss√≠vel carregar a chave!")
        print("    Certifique-se de que o arquivo 'chave_secreta.key' existe.")
        sys.exit(1)
    
    # Descriptografa os arquivos
    print("\n[*] Procurando arquivos criptografados...")
    num_descriptografados = decryptor.descriptografar_todos()
    
    if num_descriptografados > 0:
        print("\n" + "=" * 60)
        print("  ‚úÖ ARQUIVOS RECUPERADOS COM SUCESSO!")
        print("=" * 60)
        
        # Pergunta se deseja limpar arquivos auxiliares
        limpar = input("\nDeseja remover os arquivos auxiliares? (sim/n√£o): ").lower()
        if limpar in ['sim', 's', 'yes', 'y']:
            decryptor.limpar_arquivos_auxiliares()
        
        print("\nüìö Pr√≥ximos passos:")
        print("   1. Verifique seus arquivos em 'test_files/'")
        print("   2. Todos os arquivos foram restaurados ao estado original")
        print("   3. Revise a documenta√ß√£o sobre preven√ß√£o de ransomware\n")
    else:
        print("\n[!] Nenhum arquivo foi descriptografado!")
        print("    Verifique se existem arquivos .encrypted no diret√≥rio test_files/\n")


if __name__ == "__main__":
    main()
